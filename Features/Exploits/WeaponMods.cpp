namespace Exploits::Weapon::WeaponMods
{
    class WeaponMod
    {
    public:
        static void Update()
        {
            if (!CFG::Exploits::quick_swap)
                return;

            uintptr_t wieldedComp  = read<uintptr_t>(Cache::AcknowledgedPawn + 0x870);
            if (!wieldedComp) return;

            uintptr_t currentItem  = read<uintptr_t>(wieldedComp + 0x2E0);
            if (!currentItem) return;

            std::string itemName = GName(read<int>(currentItem + 0x24));
            if (!IsSupportedWeapon(itemName)) return;

            uintptr_t weaponParams = read<uintptr_t>(currentItem + 0x848);
            if (!weaponParams) return;

            ApplyModifications(weaponParams);
        }

    private:

        struct WeaponOffset
        {
            const char* name;
            uintptr_t   offset;
            float       value;
        };

        static bool IsSupportedWeapon(const std::string& name)
        {
            return  name.starts_with("BP_wpn_flintlock_pistol") ||
                    name.starts_with("BP_wpn_blunderbuss")      ||
                    name.starts_with("BP_wpn_sniper_rifle");
        }

        static bool IsValidOffset(const WeaponOffset& o)
        {
            return SDK->find(o.name);
        }

        static void SafeWriteFloat(uintptr_t base, const WeaponOffset& o)
        {
            try { write<float>(base + o.offset, o.value); }
            catch (...) {}
        }

        static void ApplyModifications(uintptr_t weaponBase)
        {
            static WeaponOffset offsets[] =
            {
                { "EquipDuration",                   0x0C,      0.001f      },
                { "IntoAimingDuration",              0x10,      0.000001f   },
                { "RecoilDuration",                  0x14,      0.19999999f },
                { "ZoomedRecoilDurationIncrease",    0x174,     -10.f       },
                { "NumberOfProjectiles",             0x5C,      1.f         },
                { "InaccuracySeed",                  0x54,      0.f         }
            };

            for (auto& o : offsets)
            {
                if (IsValidOffset(o))
                    SafeWriteFloat(weaponBase, o);
            }
        }
    };
}
